name: Provision & Configure Compute

on:
  workflow_dispatch:
    inputs:
      provider:
        description: "cloud provider: aws or oci"
        required: true
        default: "aws"

jobs:
  provision:
    runs-on: ubuntu-latest
    env:
      TF_IN_AUTOMATION: "true"

    steps:
      # 0) Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials
        if: ${{ github.event.inputs.provider == 'aws' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        working-directory: infra/terraform/${{ github.event.inputs.provider }}
        run: terraform init -input=false

      - name: Terraform Apply
        id: tfapply
        working-directory: infra/terraform/${{ github.event.inputs.provider }}
        env:
          TF_VAR_region:     ${{ secrets.AWS_REGION }}
          TF_VAR_name:       ${{ secrets.CLUSTER_NAME }}
          TF_VAR_vpc_id:     ${{ secrets.AWS_VPC_ID }}
          TF_VAR_vpc_cidr:   ${{ secrets.AWS_VPC_CIDR }}
          TF_VAR_subnet_id:  ${{ secrets.AWS_SUBNET_ID }}
          TF_VAR_ami_id:     ${{ secrets.AWS_AMI_ID }}
          TF_VAR_ssh_cidr:   ${{ secrets.SSH_CIDR }}
          TF_VAR_key_name:   ${{ secrets.AWS_KEY_NAME }}
          TF_VAR_public_key: ${{ secrets.PUBLIC_KEY }}
          TF_VAR_ssh_user:   ${{ secrets.SSH_USER }}
        run: terraform apply -auto-approve

      # 2) Read Terraform outputs
      - name: Install jq (for parsing outputs)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Read Terraform outputs (JSON)
        id: tfout
        working-directory: infra/terraform/${{ github.event.inputs.provider }}
        shell: bash
        run: |
          j=$(terraform output -json)
          echo "public_ip=$(echo "$j" | jq -r '.public_ip.value')" >> "$GITHUB_OUTPUT"
          echo "ssh_user=$(echo "$j" | jq -r '.ssh_user.value')" >> "$GITHUB_OUTPUT"

      # 3) Write Ansible inventory
      - name: Write inventory
        shell: bash
        run: |
          mkdir -p ansible/inventory
          cat > ansible/inventory/hosts <<EOF
          [compute]
          ${{ steps.tfout.outputs.public_ip }} ansible_user=${{ steps.tfout.outputs.ssh_user }}
          EOF
          echo "Wrote ansible/inventory/hosts"
          cat ansible/inventory/hosts

      # 4) SSH key from base64 secret (single long line)
      - name: Write SSH key (decoded from base64)
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY_B64 }}" | base64 -d > ~/.ssh/id_automation
          chmod 600 ~/.ssh/id_automation
          # Sanity check (exit 0 if valid)
          ssh-keygen -yf ~/.ssh/id_automation >/dev/null

      - name: Add host key
        shell: bash
        run: |
          ssh-keyscan -H ${{ steps.tfout.outputs.public_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true
          tail -n 2 ~/.ssh/known_hosts || true

      - name: Test SSH connectivity
        shell: bash
        run: |
          ssh -o ConnectTimeout=15 -o StrictHostKeyChecking=no \
              -i ~/.ssh/id_automation \
              ${{ steps.tfout.outputs.ssh_user }}@${{ steps.tfout.outputs.public_ip }} "uname -a && echo 'SSH OK'"

      # 5) Ansible (optional site.yml)
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Ansible
        run: pip install ansible

      - name: Run Ansible (ping + optional site.yml)
        working-directory: ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: "false"
        shell: bash
        run: |
          ansible -i inventory/hosts all -m ping \
            --ssh-extra-args="-i ~/.ssh/id_automation -o StrictHostKeyChecking=no"

          if [ -f site.yml ]; then
            ansible-playbook -i inventory/hosts site.yml \
              --ssh-extra-args="-i ~/.ssh/id_automation -o StrictHostKeyChecking=no"
          else
            echo "No site.yml found; ping-only completed."
          fi
